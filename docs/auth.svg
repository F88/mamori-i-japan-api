<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="919px" preserveAspectRatio="none" style="width:1220px;height:919px;" version="1.1" viewBox="0 0 1220 919" width="1220px" zoomAndPan="magnify"><defs><filter height="300%" id="f12aqdqexkfkn2" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="39" x2="39" y1="38.2969" y2="879.6172"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="256" x2="256" y1="38.2969" y2="879.6172"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="777" x2="777" y1="38.2969" y2="879.6172"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1163" x2="1163" y1="38.2969" y2="879.6172"/><rect fill="#FEFECE" filter="url(#f12aqdqexkfkn2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="59" x="8" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45" x="15" y="22.9951">Mobile</text><rect fill="#FEFECE" filter="url(#f12aqdqexkfkn2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="59" x="8" y="878.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45" x="15" y="898.6123">Mobile</text><rect fill="#FEFECE" filter="url(#f12aqdqexkfkn2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="105" x="202" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="209" y="22.9951">FirebaseAuth</text><rect fill="#FEFECE" filter="url(#f12aqdqexkfkn2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="105" x="202" y="878.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="209" y="898.6123">FirebaseAuth</text><rect fill="#FEFECE" filter="url(#f12aqdqexkfkn2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="738" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="745" y="22.9951">Backend</text><rect fill="#FEFECE" filter="url(#f12aqdqexkfkn2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="738" y="878.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="745" y="898.6123">Backend</text><rect fill="#FEFECE" filter="url(#f12aqdqexkfkn2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="1124" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="1131" y="22.9951">Firestore</text><rect fill="#FEFECE" filter="url(#f12aqdqexkfkn2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="1124" y="878.6172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="1131" y="898.6123">Firestore</text><rect fill="#EEEEEE" filter="url(#f12aqdqexkfkn2)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1205" x="3" y="68.8633"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1208" y1="68.8633" y2="68.8633"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1208" y1="71.8633" y2="71.8633"/><rect fill="#EEEEEE" filter="url(#f12aqdqexkfkn2)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="71" x="570" y="58.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="52" x="576" y="74.3638">SignUp</text><polygon fill="#A80036" points="244.5,108.5625,254.5,112.5625,244.5,116.5625,248.5,112.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="39.5" x2="250.5" y1="112.5625" y2="112.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="46.5" y="107.4966">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="59.5" y="107.4966">SMS request</text><polygon fill="#A80036" points="50.5,137.6953,40.5,141.6953,50.5,145.6953,46.5,141.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="44.5" x2="255.5" y1="141.6953" y2="141.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="56.5" y="136.6294">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="69.5" y="136.6294">OTP code</text><polygon fill="#A80036" points="244.5,166.8281,254.5,170.8281,244.5,174.8281,248.5,170.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="39.5" x2="250.5" y1="170.8281" y2="170.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="46.5" y="165.7622">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="59.5" y="165.7622">send OTP</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="256.5" x2="298.5" y1="199.9609" y2="199.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298.5" x2="298.5" y1="199.9609" y2="212.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="257.5" x2="298.5" y1="212.9609" y2="212.9609"/><polygon fill="#A80036" points="267.5,208.9609,257.5,212.9609,267.5,216.9609,263.5,212.9609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="263.5" y="194.895">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="276.5" y="194.895">verify OTP code</text><polygon fill="#A80036" points="50.5,238.0938,40.5,242.0938,50.5,246.0938,46.5,242.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="44.5" x2="255.5" y1="242.0938" y2="242.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="56.5" y="237.0278">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="69.5" y="237.0278">Firebase Default Token(FDT)</text><polygon fill="#A80036" points="765.5,267.2266,775.5,271.2266,765.5,275.2266,769.5,271.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="39.5" x2="771.5" y1="271.2266" y2="271.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="46.5" y="266.1606">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="59.5" y="266.1606">POST /auth/sign_up with FDT, prefecture, job</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="777.5" x2="819.5" y1="300.3594" y2="300.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="819.5" x2="819.5" y1="300.3594" y2="313.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="778.5" x2="819.5" y1="313.3594" y2="313.3594"/><polygon fill="#A80036" points="788.5,309.3594,778.5,313.3594,788.5,317.3594,784.5,313.3594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="784.5" y="295.2935">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="797.5" y="295.2935">verify FDT</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="777.5" x2="819.5" y1="342.4922" y2="342.4922"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="819.5" x2="819.5" y1="342.4922" y2="355.4922"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="778.5" x2="819.5" y1="355.4922" y2="355.4922"/><polygon fill="#A80036" points="788.5,351.4922,778.5,355.4922,788.5,359.4922,784.5,355.4922" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="784.5" y="337.4263">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="797.5" y="337.4263">extract phoneno from FDT</text><polygon fill="#A80036" points="267.5,380.625,257.5,384.625,267.5,388.625,263.5,384.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="261.5" x2="776.5" y1="384.625" y2="384.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="273.5" y="379.5591">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="484" x="286.5" y="379.5591">firebaseAdmin.auth().updateUser(uid, {phoneNumber: null,disabled: false})</text><polygon fill="#A80036" points="765.5,409.7578,775.5,413.7578,765.5,417.7578,769.5,413.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="256.5" x2="771.5" y1="413.7578" y2="413.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="263.5" y="408.6919">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="285.5" y="408.6919">uid</text><polygon fill="#A80036" points="1151.5,438.8906,1161.5,442.8906,1151.5,446.8906,1155.5,442.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="777.5" x2="1157.5" y1="442.8906" y2="442.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="784.5" y="437.8247">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="806.5" y="437.8247">create user core data(hashed or encrypted phoneno)</text><polygon fill="#A80036" points="788.5,468.0234,778.5,472.0234,788.5,476.0234,784.5,472.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="782.5" x2="1162.5" y1="472.0234" y2="472.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="794.5" y="466.9575">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="816.5" y="466.9575">ok</text><polygon fill="#A80036" points="1151.5,497.1563,1161.5,501.1563,1151.5,505.1563,1155.5,501.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="777.5" x2="1157.5" y1="501.1563" y2="501.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="784.5" y="496.0903">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="806.5" y="496.0903">create user profile(prefecture, job)</text><polygon fill="#A80036" points="788.5,526.2891,778.5,530.2891,788.5,534.2891,784.5,530.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="782.5" x2="1162.5" y1="530.2891" y2="530.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="794.5" y="525.2231">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="816.5" y="525.2231">ok</text><polygon fill="#A80036" points="50.5,555.4219,40.5,559.4219,50.5,563.4219,46.5,559.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="44.5" x2="776.5" y1="559.4219" y2="559.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="56.5" y="554.356">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="78.5" y="554.356">ok</text><polygon fill="#A80036" points="244.5,584.5547,254.5,588.5547,244.5,592.5547,248.5,588.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="39.5" x2="250.5" y1="588.5547" y2="588.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="46.5" y="583.4888">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="68.5" y="583.4888">getIDTokenForcingRefresh</text><polygon fill="#A80036" points="50.5,613.6875,40.5,617.6875,50.5,621.6875,46.5,617.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="44.5" x2="255.5" y1="617.6875" y2="617.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="56.5" y="612.6216">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="78.5" y="612.6216">ok</text><rect fill="#EEEEEE" filter="url(#f12aqdqexkfkn2)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1205" x="3" y="646.2539"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1208" y1="646.2539" y2="646.2539"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1208" y1="649.2539" y2="649.2539"/><rect fill="#EEEEEE" filter="url(#f12aqdqexkfkn2)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="177" x="517" y="635.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="523" y="651.7544">Reqeust API example</text><polygon fill="#A80036" points="765.5,685.9531,775.5,689.9531,765.5,693.9531,769.5,689.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="39.5" x2="771.5" y1="689.9531" y2="689.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="46.5" y="684.8872">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="59.5" y="684.8872">GET /users/me/temp_ids with custom claimed token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="777.5" x2="819.5" y1="719.0859" y2="719.0859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="819.5" x2="819.5" y1="719.0859" y2="732.0859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="778.5" x2="819.5" y1="732.0859" y2="732.0859"/><polygon fill="#A80036" points="788.5,728.0859,778.5,732.0859,788.5,736.0859,784.5,732.0859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="784.5" y="714.02">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="797.5" y="714.02">verify custom claimed token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="777.5" x2="819.5" y1="761.2188" y2="761.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="819.5" x2="819.5" y1="761.2188" y2="774.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="778.5" x2="819.5" y1="774.2188" y2="774.2188"/><polygon fill="#A80036" points="788.5,770.2188,778.5,774.2188,788.5,778.2188,784.5,774.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="784.5" y="756.1528">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="797.5" y="756.1528">extract uid from custom claimed token</text><polygon fill="#A80036" points="1151.5,799.3516,1161.5,803.3516,1151.5,807.3516,1155.5,803.3516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="777.5" x2="1157.5" y1="803.3516" y2="803.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="784.5" y="798.2856">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="797.5" y="798.2856">save temp_ids with uid</text><polygon fill="#A80036" points="788.5,828.4844,778.5,832.4844,788.5,836.4844,784.5,832.4844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="782.5" x2="1162.5" y1="832.4844" y2="832.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="794.5" y="827.4185">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="807.5" y="827.4185">okay</text><polygon fill="#A80036" points="50.5,857.6172,40.5,861.6172,50.5,865.6172,46.5,861.6172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="44.5" x2="776.5" y1="861.6172" y2="861.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="56.5" y="856.5513">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="59" x="69.5" y="856.5513">temp_ids</text><!--MD5=[ae3ae0dea14169ac54cd038d77e60b63]
@startuml
== SignUp ==

autonumber 1

Mobile  -> FirebaseAuth: SMS request
FirebaseAuth -> Mobile: OTP code
Mobile  -> FirebaseAuth: send OTP
FirebaseAuth -> FirebaseAuth: verify OTP code
FirebaseAuth -> Mobile: Firebase Default Token(FDT)
Mobile -> Backend: POST /auth/sign_up with FDT, prefecture, job
Backend -> Backend: verify FDT
Backend -> Backend: extract phoneno from FDT
Backend ->  FirebaseAuth: firebaseAdmin.auth().updateUser(uid, {phoneNumber: null,disabled: false})
FirebaseAuth -> Backend: uid
Backend -> Firestore: create user core data(hashed or encrypted phoneno)
Firestore -> Backend: ok
Backend -> Firestore: create user profile(prefecture, job)
Firestore -> Backend: ok
Backend -> Mobile: ok
Mobile -> FirebaseAuth: getIDTokenForcingRefresh
FirebaseAuth -> Mobile: ok

== Reqeust API example ==

autonumber 1
Mobile -> Backend: GET /users/me/temp_ids with custom claimed token
Backend -> Backend: verify custom claimed token
Backend -> Backend: extract uid from custom claimed token
Backend -> Firestore: save temp_ids with uid
Firestore -> Backend: okay
Backend -> Mobile: temp_ids
@enduml

PlantUML version 1.2019.12(Sun Nov 03 10:24:54 UTC 2019)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_232-heroku-b09
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>