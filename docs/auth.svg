<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="819px" preserveAspectRatio="none" style="width:1115px;height:819px;" version="1.1" viewBox="0 0 1115 819" width="1115px" zoomAndPan="magnify"><defs><filter height="300%" id="fgr4ybi50paex" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="39" x2="39" y1="38.2969" y2="779.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="256" x2="256" y1="38.2969" y2="779.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="681" x2="681" y1="38.2969" y2="779.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1058" x2="1058" y1="38.2969" y2="779.2188"/><rect fill="#FEFECE" filter="url(#fgr4ybi50paex)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="59" x="8" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45" x="15" y="22.9951">Mobile</text><rect fill="#FEFECE" filter="url(#fgr4ybi50paex)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="59" x="8" y="778.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45" x="15" y="798.2139">Mobile</text><rect fill="#FEFECE" filter="url(#fgr4ybi50paex)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="105" x="202" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="209" y="22.9951">FirebaseAuth</text><rect fill="#FEFECE" filter="url(#fgr4ybi50paex)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="105" x="202" y="778.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="209" y="798.2139">FirebaseAuth</text><rect fill="#FEFECE" filter="url(#fgr4ybi50paex)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="642" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="649" y="22.9951">Backend</text><rect fill="#FEFECE" filter="url(#fgr4ybi50paex)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="642" y="778.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="649" y="798.2139">Backend</text><rect fill="#FEFECE" filter="url(#fgr4ybi50paex)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="1019" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="1026" y="22.9951">Firestore</text><rect fill="#FEFECE" filter="url(#fgr4ybi50paex)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="1019" y="778.2188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="1026" y="798.2139">Firestore</text><rect fill="#EEEEEE" filter="url(#fgr4ybi50paex)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1100" x="3" y="68.8633"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1103" y1="68.8633" y2="68.8633"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1103" y1="71.8633" y2="71.8633"/><rect fill="#EEEEEE" filter="url(#fgr4ybi50paex)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="59" x="523.5" y="58.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="40" x="529.5" y="74.3638">Login</text><polygon fill="#A80036" points="244.5,108.5625,254.5,112.5625,244.5,116.5625,248.5,112.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="39.5" x2="250.5" y1="112.5625" y2="112.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="46.5" y="107.4966">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="59.5" y="107.4966">Anonymous Auth</text><polygon fill="#A80036" points="50.5,137.6953,40.5,141.6953,50.5,145.6953,46.5,141.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="44.5" x2="255.5" y1="141.6953" y2="141.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="56.5" y="136.6294">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="69.5" y="136.6294">Firebase Default Token(FDT)</text><polygon fill="#A80036" points="669.5,166.8281,679.5,170.8281,669.5,174.8281,673.5,170.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="39.5" x2="675.5" y1="170.8281" y2="170.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="46.5" y="165.7622">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="59.5" y="165.7622">POST /auth/login with FDT, prefecture</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="723.5" y1="199.9609" y2="199.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="723.5" x2="723.5" y1="199.9609" y2="212.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="682.5" x2="723.5" y1="212.9609" y2="212.9609"/><polygon fill="#A80036" points="692.5,208.9609,682.5,212.9609,692.5,216.9609,688.5,212.9609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="688.5" y="194.895">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="701.5" y="194.895">verify FDT</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="723.5" y1="242.0938" y2="242.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="723.5" x2="723.5" y1="242.0938" y2="255.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="682.5" x2="723.5" y1="255.0938" y2="255.0938"/><polygon fill="#A80036" points="692.5,251.0938,682.5,255.0938,692.5,259.0938,688.5,255.0938" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="688.5" y="237.0278">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="701.5" y="237.0278">Validate FDT provider is anonymous</text><polygon fill="#A80036" points="1046.5,280.2266,1056.5,284.2266,1046.5,288.2266,1050.5,284.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="1052.5" y1="284.2266" y2="284.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="688.5" y="279.1606">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="701.5" y="279.1606">create user core data(hashed or encrypted phoneno)</text><polygon fill="#A80036" points="692.5,309.3594,682.5,313.3594,692.5,317.3594,688.5,313.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="686.5" x2="1057.5" y1="313.3594" y2="313.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="698.5" y="308.2935">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="711.5" y="308.2935">ok</text><polygon fill="#A80036" points="1046.5,338.4922,1056.5,342.4922,1046.5,346.4922,1050.5,342.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="1052.5" y1="342.4922" y2="342.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="688.5" y="337.4263">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="701.5" y="337.4263">create user profile(prefecture, job)</text><polygon fill="#A80036" points="692.5,367.625,682.5,371.625,692.5,375.625,688.5,371.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="686.5" x2="1057.5" y1="371.625" y2="371.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="698.5" y="366.5591">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="711.5" y="366.5591">ok</text><polygon fill="#A80036" points="267.5,396.7578,257.5,400.7578,267.5,404.7578,263.5,400.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="261.5" x2="680.5" y1="400.7578" y2="400.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="273.5" y="395.6919">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="295.5" y="395.6919">firebaseAdmin.auth().setCustomUserClaims(isNormalUser)</text><polygon fill="#A80036" points="669.5,425.8906,679.5,429.8906,669.5,433.8906,673.5,429.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="256.5" x2="675.5" y1="429.8906" y2="429.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="263.5" y="424.8247">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="285.5" y="424.8247">ok</text><polygon fill="#A80036" points="50.5,455.0234,40.5,459.0234,50.5,463.0234,46.5,459.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="44.5" x2="680.5" y1="459.0234" y2="459.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="56.5" y="453.9575">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="78.5" y="453.9575">ok</text><polygon fill="#A80036" points="244.5,484.1563,254.5,488.1563,244.5,492.1563,248.5,488.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="39.5" x2="250.5" y1="488.1563" y2="488.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="46.5" y="483.0903">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="68.5" y="483.0903">getIDTokenForcingRefresh</text><polygon fill="#A80036" points="50.5,513.2891,40.5,517.2891,50.5,521.2891,46.5,517.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="44.5" x2="255.5" y1="517.2891" y2="517.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="56.5" y="512.2231">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="78.5" y="512.2231">ok</text><rect fill="#EEEEEE" filter="url(#fgr4ybi50paex)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1100" x="3" y="545.8555"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1103" y1="545.8555" y2="545.8555"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1103" y1="548.8555" y2="548.8555"/><rect fill="#EEEEEE" filter="url(#fgr4ybi50paex)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="177" x="464.5" y="535.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="470.5" y="551.356">Reqeust API example</text><polygon fill="#A80036" points="669.5,585.5547,679.5,589.5547,669.5,593.5547,673.5,589.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="39.5" x2="675.5" y1="589.5547" y2="589.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="46.5" y="584.4888">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="59.5" y="584.4888">GET /users/me/temp_ids with custom claimed token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="723.5" y1="618.6875" y2="618.6875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="723.5" x2="723.5" y1="618.6875" y2="631.6875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="682.5" x2="723.5" y1="631.6875" y2="631.6875"/><polygon fill="#A80036" points="692.5,627.6875,682.5,631.6875,692.5,635.6875,688.5,631.6875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="688.5" y="613.6216">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="701.5" y="613.6216">verify custom claimed token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="723.5" y1="660.8203" y2="660.8203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="723.5" x2="723.5" y1="660.8203" y2="673.8203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="682.5" x2="723.5" y1="673.8203" y2="673.8203"/><polygon fill="#A80036" points="692.5,669.8203,682.5,673.8203,692.5,677.8203,688.5,673.8203" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="688.5" y="655.7544">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="701.5" y="655.7544">extract uid from custom claimed token</text><polygon fill="#A80036" points="1046.5,698.9531,1056.5,702.9531,1046.5,706.9531,1050.5,702.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="1052.5" y1="702.9531" y2="702.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="688.5" y="697.8872">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="701.5" y="697.8872">save temp_ids with uid</text><polygon fill="#A80036" points="692.5,728.0859,682.5,732.0859,692.5,736.0859,688.5,732.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="686.5" x2="1057.5" y1="732.0859" y2="732.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="698.5" y="727.02">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="711.5" y="727.02">okay</text><polygon fill="#A80036" points="50.5,757.2188,40.5,761.2188,50.5,765.2188,46.5,761.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="44.5" x2="680.5" y1="761.2188" y2="761.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="56.5" y="756.1528">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="59" x="69.5" y="756.1528">temp_ids</text><!--
@startuml

== Login ==

autonumber 1

Mobile  -> FirebaseAuth: Anonymous Auth
FirebaseAuth -> Mobile: Firebase Default Token(FDT)
Mobile -> Backend: POST /auth/login with FDT, prefecture
Backend -> Backend: verify FDT
Backend -> Backend: Validate FDT provider is anonymous
Backend -> Firestore: create user core data(hashed or encrypted phoneno)
Firestore -> Backend: ok
Backend -> Firestore: create user profile(prefecture, job)
Firestore -> Backend: ok
Backend ->  FirebaseAuth: firebaseAdmin.auth().setCustomUserClaims(isNormalUser)
FirebaseAuth -> Backend: ok
Backend -> Mobile: ok
Mobile -> FirebaseAuth: getIDTokenForcingRefresh
FirebaseAuth -> Mobile: ok

== Reqeust API example ==

autonumber 1
Mobile -> Backend: GET /users/me/temp_ids with custom claimed token
Backend -> Backend: verify custom claimed token
Backend -> Backend: extract uid from custom claimed token
Backend -> Firestore: save temp_ids with uid
Firestore -> Backend: okay
Backend -> Mobile: temp_ids

@enduml

PlantUML version 1.2019.09(Tue Aug 27 01:19:51 JST 2019)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.7+10-post-Ubuntu-2ubuntu218.04
Operating System: Linux
OS Version: 5.3.0-46-generic
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>