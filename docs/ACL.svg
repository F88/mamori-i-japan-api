<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1093px" preserveAspectRatio="none" style="width:936px;height:1093px;" version="1.1" viewBox="0 0 936 1093" width="936px" zoomAndPan="magnify"><defs><filter height="300%" id="fyh95woimxc7y" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="31" x="448" y="22.9951">ACL</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="48" x2="48" y1="116.5938" y2="1006.2422"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="286.5" x2="286.5" y1="116.5938" y2="1006.2422"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="602.5" x2="602.5" y1="116.5938" y2="1006.2422"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="842" x2="842" y1="116.5938" y2="1006.2422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="8" y="113.292">AdminUser</text><ellipse cx="48.5" cy="43.2969" fill="#FEFECE" filter="url(#fyh95woimxc7y)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M48.5,51.2969 L48.5,78.2969 M35.5,59.2969 L61.5,59.2969 M48.5,78.2969 L35.5,93.2969 M48.5,78.2969 L61.5,93.2969 " fill="none" filter="url(#fyh95woimxc7y)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="8" y="1018.2373">AdminUser</text><ellipse cx="48.5" cy="1031.5391" fill="#FEFECE" filter="url(#fyh95woimxc7y)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M48.5,1039.5391 L48.5,1066.5391 M35.5,1047.5391 L61.5,1047.5391 M48.5,1066.5391 L35.5,1081.5391 M48.5,1066.5391 L61.5,1081.5391 " fill="none" filter="url(#fyh95woimxc7y)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#fyh95woimxc7y)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="232.5" y="81.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="239.5" y="101.292">NestJS Guard</text><rect fill="#FEFECE" filter="url(#fyh95woimxc7y)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="232.5" y="1005.2422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="239.5" y="1025.2373">NestJS Guard</text><rect fill="#FEFECE" filter="url(#fyh95woimxc7y)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="64" x="568.5" y="81.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="575.5" y="101.292">Service</text><rect fill="#FEFECE" filter="url(#fyh95woimxc7y)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="64" x="568.5" y="1005.2422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="575.5" y="1025.2373">Service</text><rect fill="#FEFECE" filter="url(#fyh95woimxc7y)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="803" y="81.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="810" y="101.292">Firestore</text><rect fill="#FEFECE" filter="url(#fyh95woimxc7y)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="803" y="1005.2422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="810" y="1025.2373">Firestore</text><rect fill="#EEEEEE" filter="url(#fyh95woimxc7y)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="921" x="3" y="147.1602"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="924" y1="147.1602" y2="147.1602"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="924" y1="150.1602" y2="150.1602"/><rect fill="#EEEEEE" filter="url(#fyh95woimxc7y)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="183" x="372" y="136.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="164" x="378" y="152.6606">ACL on LIST endpoints</text><polygon fill="#A80036" points="274.5,186.8594,284.5,190.8594,274.5,194.8594,278.5,190.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="48.5" x2="280.5" y1="190.8594" y2="190.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="55.5" y="185.7935">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="68.5" y="185.7935">GET /admins/organizations</text><path d="M207,203.8594 L207,273.8594 L361,273.8594 L361,213.8594 L351,203.8594 L207,203.8594 " fill="#FBFB77" filter="url(#fyh95woimxc7y)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M351,203.8594 L351,213.8594 L361,213.8594 L351,203.8594 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="213" y="220.9263">Expects JWT Payload:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="213" y="236.0591">- isAdminUser</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="213" y="251.1919">- userAdminRole</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="213" y="266.3247">- userAccessKey</text><polygon fill="#A80036" points="590.5,300.5234,600.5,304.5234,590.5,308.5234,594.5,304.5234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="286.5" x2="596.5" y1="304.5234" y2="304.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="293.5" y="299.4575">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="306.5" y="299.4575">Pass userAccessKey to organization service</text><path d="M336,317.5234 L336,357.5234 L593,357.5234 L593,327.5234 L583,317.5234 L336,317.5234 " fill="#FBFB77" filter="url(#fyh95woimxc7y)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M583,317.5234 L583,327.5234 L593,327.5234 L583,317.5234 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="342" y="334.5903">Example value:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="342" y="349.7231">- userAccessKey: SUPER_ADMIN_KEY</text><polygon fill="#A80036" points="830.5,399.0547,840.5,403.0547,830.5,407.0547,834.5,403.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="602.5" x2="836.5" y1="403.0547" y2="403.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="609.5" y="390.4224">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="622.5" y="382.856">Fetch all accessible documents</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="626.5" y="397.9888">in organizations collection</text><path d="M766,416.0547 L766,501.0547 L915,501.0547 L915,426.0547 L905,416.0547 L766,416.0547 " fill="#FBFB77" filter="url(#fyh95woimxc7y)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M905,416.0547 L905,426.0547 L915,426.0547 L905,416.0547 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="772" y="433.1216">.where(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="780" y="448.2544">accessControlList,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="780" y="463.3872">array-contains,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="780" y="478.52">userAccessKey</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="772" y="493.6528">)</text><polygon fill="#A80036" points="613.5,527.8516,603.5,531.8516,613.5,535.8516,609.5,531.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="607.5" x2="841.5" y1="531.8516" y2="531.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="619.5" y="526.7856">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="632.5" y="526.7856">Return array of organizations</text><polygon fill="#A80036" points="59.5,556.9844,49.5,560.9844,59.5,564.9844,55.5,560.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="53.5" x2="601.5" y1="560.9844" y2="560.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="65.5" y="555.9185">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="78.5" y="555.9185">Organizations LIST based on ACL</text><rect fill="#EEEEEE" filter="url(#fyh95woimxc7y)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="921" x="3" y="589.5508"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="924" y1="589.5508" y2="589.5508"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="924" y1="592.5508" y2="592.5508"/><rect fill="#EEEEEE" filter="url(#fyh95woimxc7y)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="225" x="351" y="578.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="357" y="595.0513">ACL on GET by ID endpoints</text><polygon fill="#A80036" points="274.5,629.25,284.5,633.25,274.5,637.25,278.5,633.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="48.5" x2="280.5" y1="633.25" y2="633.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="55.5" y="628.1841">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="68.5" y="628.1841">GET /admins/organizations/ABC</text><path d="M207,646.25 L207,716.25 L361,716.25 L361,656.25 L351,646.25 L207,646.25 " fill="#FBFB77" filter="url(#fyh95woimxc7y)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M351,646.25 L351,656.25 L361,656.25 L351,646.25 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="213" y="663.3169">Expects JWT Payload:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="213" y="678.4497">- isAdminUser</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="213" y="693.5825">- userAdminRole</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="213" y="708.7153">- userAccessKey</text><polygon fill="#A80036" points="590.5,742.9141,600.5,746.9141,590.5,750.9141,594.5,746.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="286.5" x2="596.5" y1="746.9141" y2="746.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="293.5" y="741.8481">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="306.5" y="741.8481">Pass userAccessKey to organization service</text><path d="M336,759.9141 L336,799.9141 L593,799.9141 L593,769.9141 L583,759.9141 L336,759.9141 " fill="#FBFB77" filter="url(#fyh95woimxc7y)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M583,759.9141 L583,769.9141 L593,769.9141 L583,759.9141 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="342" y="776.981">Example value:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="342" y="792.1138">- userAccessKey: SUPER_ADMIN_KEY</text><polygon fill="#A80036" points="830.5,841.4453,840.5,845.4453,830.5,849.4453,834.5,845.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="602.5" x2="836.5" y1="845.4453" y2="845.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="609.5" y="832.813">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="622.5" y="825.2466">Fetch single document</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="626.5" y="840.3794">based on ID ABC</text><polygon fill="#A80036" points="613.5,870.5781,603.5,874.5781,613.5,878.5781,609.5,874.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="607.5" x2="841.5" y1="874.5781" y2="874.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="619.5" y="869.5122">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="632.5" y="869.5122">Return ABC organization</text><path d="M509,887.5781 L509,957.5781 L692,957.5781 L692,897.5781 L682,887.5781 L509,887.5781 " fill="#FBFB77" filter="url(#fyh95woimxc7y)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M682,887.5781 L682,897.5781 L692,897.5781 L682,887.5781 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="515" y="904.645">canUserAccessResource(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="523" y="919.7778">userAccessKey,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="523" y="934.9106">organization</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="515" y="950.0435">)</text><polygon fill="#A80036" points="59.5,984.2422,49.5,988.2422,59.5,992.2422,55.5,988.2422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="53.5" x2="601.5" y1="988.2422" y2="988.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="65.5" y="983.1763">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="78.5" y="983.1763">Organizations GET by ID based on ACL</text><!--
@startuml

title ACL

== ACL on LIST endpoints ==
autonumber 1

actor AdminUser
AdminUser  -> "NestJS Guard": GET /admins/organizations
note over "NestJS Guard" 
Expects JWT Payload:
- isAdminUser 
- userAdminRole 
- userAccessKey
end note

"NestJS Guard" -> "Service":  Pass userAccessKey to organization service
note left "Service" 
Example value: 
- userAccessKey: SUPER_ADMIN_KEY
end note

"Service" -> "Firestore": Fetch all accessible documents \n in organizations collection
note over "Firestore" 
.where(
  accessControlList, 
  array-contains, 
  userAccessKey
)
end note

"Firestore" -> "Service": Return array of organizations

"Service" -> "AdminUser": Organizations LIST based on ACL


== ACL on GET by ID endpoints ==
autonumber 1

AdminUser  -> "NestJS Guard": GET /admins/organizations/ABC
note over "NestJS Guard" 
Expects JWT Payload:
- isAdminUser 
- userAdminRole 
- userAccessKey
end note

"NestJS Guard" -> "Service":  Pass userAccessKey to organization service
note left "Service" 
Example value: 
- userAccessKey: SUPER_ADMIN_KEY
end note

"Service" -> "Firestore": Fetch single document \n based on ID ABC

"Firestore" -> "Service": Return ABC organization
note over "Service" 
canUserAccessResource(
  userAccessKey, 
  organization
)
end note

"Service" -> "AdminUser": Organizations GET by ID based on ACL

@enduml

PlantUML version 1.2019.09(Tue Aug 27 01:19:51 JST 2019)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.7+10-post-Ubuntu-2ubuntu218.04
Operating System: Linux
OS Version: 5.3.0-51-generic
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>