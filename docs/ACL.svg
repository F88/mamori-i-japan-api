<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1093px" preserveAspectRatio="none" style="width:910px;height:1093px;" version="1.1" viewBox="0 0 910 1093" width="910px" zoomAndPan="magnify"><defs><filter height="300%" id="f3q59lgjfzyua" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="31" x="435" y="22.9951">ACL</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="48" x2="48" y1="116.5938" y2="1006.2422"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="273.5" x2="273.5" y1="116.5938" y2="1006.2422"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="576.5" x2="576.5" y1="116.5938" y2="1006.2422"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="816" x2="816" y1="116.5938" y2="1006.2422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="8" y="113.292">AdminUser</text><ellipse cx="48.5" cy="43.2969" fill="#FEFECE" filter="url(#f3q59lgjfzyua)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M48.5,51.2969 L48.5,78.2969 M35.5,59.2969 L61.5,59.2969 M48.5,78.2969 L35.5,93.2969 M48.5,78.2969 L61.5,93.2969 " fill="none" filter="url(#f3q59lgjfzyua)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="8" y="1018.2373">AdminUser</text><ellipse cx="48.5" cy="1031.5391" fill="#FEFECE" filter="url(#f3q59lgjfzyua)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M48.5,1039.5391 L48.5,1066.5391 M35.5,1047.5391 L61.5,1047.5391 M48.5,1066.5391 L35.5,1081.5391 M48.5,1066.5391 L61.5,1081.5391 " fill="none" filter="url(#f3q59lgjfzyua)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f3q59lgjfzyua)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="219.5" y="81.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="226.5" y="101.292">NestJS Guard</text><rect fill="#FEFECE" filter="url(#f3q59lgjfzyua)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="219.5" y="1005.2422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="226.5" y="1025.2373">NestJS Guard</text><rect fill="#FEFECE" filter="url(#f3q59lgjfzyua)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="64" x="542.5" y="81.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="549.5" y="101.292">Service</text><rect fill="#FEFECE" filter="url(#f3q59lgjfzyua)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="64" x="542.5" y="1005.2422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="549.5" y="1025.2373">Service</text><rect fill="#FEFECE" filter="url(#f3q59lgjfzyua)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="777" y="81.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="784" y="101.292">Firestore</text><rect fill="#FEFECE" filter="url(#f3q59lgjfzyua)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="777" y="1005.2422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="784" y="1025.2373">Firestore</text><rect fill="#EEEEEE" filter="url(#f3q59lgjfzyua)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="895" x="3" y="147.1602"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="898" y1="147.1602" y2="147.1602"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="898" y1="150.1602" y2="150.1602"/><rect fill="#EEEEEE" filter="url(#f3q59lgjfzyua)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="183" x="359" y="136.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="164" x="365" y="152.6606">ACL on LIST endpoints</text><polygon fill="#A80036" points="261.5,186.8594,271.5,190.8594,261.5,194.8594,265.5,190.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="48.5" x2="267.5" y1="190.8594" y2="190.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="55.5" y="185.7935">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="68.5" y="185.7935">GET /admins/prefectures</text><path d="M194,203.8594 L194,273.8594 L348,273.8594 L348,213.8594 L338,203.8594 L194,203.8594 " fill="#FBFB77" filter="url(#f3q59lgjfzyua)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M338,203.8594 L338,213.8594 L348,213.8594 L338,203.8594 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="200" y="220.9263">Expects JWT Payload:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="200" y="236.0591">- isAdminUser</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="200" y="251.1919">- userAdminRole</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="200" y="266.3247">- userAccessKey</text><polygon fill="#A80036" points="564.5,300.5234,574.5,304.5234,564.5,308.5234,568.5,304.5234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="273.5" x2="570.5" y1="304.5234" y2="304.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="280.5" y="299.4575">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="293.5" y="299.4575">Pass userAccessKey to prefecture service</text><path d="M310,317.5234 L310,357.5234 L567,357.5234 L567,327.5234 L557,317.5234 L310,317.5234 " fill="#FBFB77" filter="url(#f3q59lgjfzyua)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M557,317.5234 L557,327.5234 L567,327.5234 L557,317.5234 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="316" y="334.5903">Example value:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="316" y="349.7231">- userAccessKey: SUPER_ADMIN_KEY</text><polygon fill="#A80036" points="804.5,399.0547,814.5,403.0547,804.5,407.0547,808.5,403.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="576.5" x2="810.5" y1="403.0547" y2="403.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="583.5" y="390.4224">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="596.5" y="382.856">Fetch all accessible documents</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="600.5" y="397.9888">in prefectures collection</text><path d="M740,416.0547 L740,501.0547 L889,501.0547 L889,426.0547 L879,416.0547 L740,416.0547 " fill="#FBFB77" filter="url(#f3q59lgjfzyua)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M879,416.0547 L879,426.0547 L889,426.0547 L879,416.0547 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="746" y="433.1216">.where(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="754" y="448.2544">accessControlList,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="754" y="463.3872">array-contains,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="754" y="478.52">userAccessKey</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="746" y="493.6528">)</text><polygon fill="#A80036" points="587.5,527.8516,577.5,531.8516,587.5,535.8516,583.5,531.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="581.5" x2="815.5" y1="531.8516" y2="531.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="593.5" y="526.7856">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606.5" y="526.7856">Return array of prefectures</text><polygon fill="#A80036" points="59.5,556.9844,49.5,560.9844,59.5,564.9844,55.5,560.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="53.5" x2="575.5" y1="560.9844" y2="560.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="65.5" y="555.9185">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="78.5" y="555.9185">prefectures LIST based on ACL</text><rect fill="#EEEEEE" filter="url(#f3q59lgjfzyua)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="895" x="3" y="589.5508"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="898" y1="589.5508" y2="589.5508"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="898" y1="592.5508" y2="592.5508"/><rect fill="#EEEEEE" filter="url(#f3q59lgjfzyua)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="225" x="338" y="578.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="344" y="595.0513">ACL on GET by ID endpoints</text><polygon fill="#A80036" points="261.5,629.25,271.5,633.25,261.5,637.25,265.5,633.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="48.5" x2="267.5" y1="633.25" y2="633.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="55.5" y="628.1841">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="68.5" y="628.1841">GET /admins/prefectures/ABC</text><path d="M194,646.25 L194,716.25 L348,716.25 L348,656.25 L338,646.25 L194,646.25 " fill="#FBFB77" filter="url(#f3q59lgjfzyua)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M338,646.25 L338,656.25 L348,656.25 L338,646.25 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="200" y="663.3169">Expects JWT Payload:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="200" y="678.4497">- isAdminUser</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="200" y="693.5825">- userAdminRole</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="200" y="708.7153">- userAccessKey</text><polygon fill="#A80036" points="564.5,742.9141,574.5,746.9141,564.5,750.9141,568.5,746.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="273.5" x2="570.5" y1="746.9141" y2="746.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="280.5" y="741.8481">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="293.5" y="741.8481">Pass userAccessKey to prefecture service</text><path d="M310,759.9141 L310,799.9141 L567,799.9141 L567,769.9141 L557,759.9141 L310,759.9141 " fill="#FBFB77" filter="url(#f3q59lgjfzyua)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M557,759.9141 L557,769.9141 L567,769.9141 L557,759.9141 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="316" y="776.981">Example value:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="316" y="792.1138">- userAccessKey: SUPER_ADMIN_KEY</text><polygon fill="#A80036" points="804.5,841.4453,814.5,845.4453,804.5,849.4453,808.5,845.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="576.5" x2="810.5" y1="845.4453" y2="845.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="583.5" y="832.813">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="596.5" y="825.2466">Fetch single document</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="600.5" y="840.3794">based on ID ABC</text><polygon fill="#A80036" points="587.5,870.5781,577.5,874.5781,587.5,878.5781,583.5,874.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="581.5" x2="815.5" y1="874.5781" y2="874.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="593.5" y="869.5122">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="606.5" y="869.5122">Return ABC prefecture</text><path d="M483,887.5781 L483,957.5781 L666,957.5781 L666,897.5781 L656,887.5781 L483,887.5781 " fill="#FBFB77" filter="url(#f3q59lgjfzyua)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M656,887.5781 L656,897.5781 L666,897.5781 L656,887.5781 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="489" y="904.645">canUserAccessResource(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="497" y="919.7778">userAccessKey,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="497" y="934.9106">prefecture</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="489" y="950.0435">)</text><polygon fill="#A80036" points="59.5,984.2422,49.5,988.2422,59.5,992.2422,55.5,988.2422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="53.5" x2="575.5" y1="988.2422" y2="988.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="65.5" y="983.1763">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="78.5" y="983.1763">prefectures GET by ID based on ACL</text><!--
@startuml

title ACL

== ACL on LIST endpoints ==
autonumber 1

actor AdminUser
AdminUser  -> "NestJS Guard": GET /admins/prefectures
note over "NestJS Guard" 
Expects JWT Payload:
- isAdminUser 
- userAdminRole 
- userAccessKey
end note

"NestJS Guard" -> "Service":  Pass userAccessKey to prefecture service
note left "Service" 
Example value: 
- userAccessKey: SUPER_ADMIN_KEY
end note

"Service" -> "Firestore": Fetch all accessible documents \n in prefectures collection
note over "Firestore" 
.where(
  accessControlList, 
  array-contains, 
  userAccessKey
)
end note

"Firestore" -> "Service": Return array of prefectures

"Service" -> "AdminUser": prefectures LIST based on ACL


== ACL on GET by ID endpoints ==
autonumber 1

AdminUser  -> "NestJS Guard": GET /admins/prefectures/ABC
note over "NestJS Guard" 
Expects JWT Payload:
- isAdminUser 
- userAdminRole 
- userAccessKey
end note

"NestJS Guard" -> "Service":  Pass userAccessKey to prefecture service
note left "Service" 
Example value: 
- userAccessKey: SUPER_ADMIN_KEY
end note

"Service" -> "Firestore": Fetch single document \n based on ID ABC

"Firestore" -> "Service": Return ABC prefecture
note over "Service" 
canUserAccessResource(
  userAccessKey, 
  prefecture
)
end note

"Service" -> "AdminUser": prefectures GET by ID based on ACL

@enduml

PlantUML version 1.2019.09(Tue Aug 27 01:19:51 JST 2019)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.7+10-post-Ubuntu-2ubuntu218.04
Operating System: Linux
OS Version: 5.3.0-51-generic
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>